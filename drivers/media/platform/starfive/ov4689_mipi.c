/*
 * Copyright (C) 2011-2013 StarFive Technology Co., Ltd. All Rights Reserved.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 */

#include <linux/module.h>
#include <linux/init.h>
#include <linux/ctype.h>
#include <linux/types.h>
#include <linux/delay.h>
#include <linux/i2c.h>
#include <linux/gpio-starfive-vic.h>
#include <linux/gpio.h>
#include <linux/delay.h>
//#include <video/stf-vin.h>
#include <linux/of.h>
#include <linux/of_gpio.h>

#ifdef SF_MIPI_DEBUG
	#define MIPI_PRT(format, args...)    printk(KERN_DEBUG "[MIPI]: " format, ## args)
	#define MIPI_INFO(format, args...)   printk(KERN_INFO "[MIPI]: " format, ## args)
	#define MIPI_ERR(format, args...)	 printk(KERN_ERR "[MIPI]: " format, ## args)
#else
	#define MIPI_PRT(x...)  do{} while(0)
	#define MIPI_INFO(x...)  do{} while(0)
	#define MIPI_ERR(x...)  do{} while(0)
#endif

#define MCLK_HZ             24000000UL
#define MCLK_INTERVAL_US   (MCLK_HZ/1000000UL)
#define REGVALLIST(list) (list), sizeof(list)/sizeof((list)[0])

typedef struct
{
    u16 addr;
    u8 val;
} regval_t;

typedef enum
{
    MODE_1080P_30FPS_4D,
    MODE_1080P_60FPS_4D,
    MODE_1080P_30FPS_2D,
    MODE_4K_30FPS_4D,
} mipicam_mode_t;

static const regval_t s_ov489_1080p_60fps_4d[] =
{
	{0x0103,0x01},
	{0x3638,0x00},
	{0x0300,0x02},
	{0x0302,0x32},
	{0x0303,0x00},
	{0x0304,0x03},
	{0x030b,0x00},
	{0x030d,0x1e},
	{0x030e,0x04},
	{0x030f,0x01},
	{0x0312,0x01},
	{0x031e,0x00},
	{0x3000,0x20},
	{0x3002,0x00},
	{0x3018,0x72},
	{0x3020,0x93},
	{0x3021,0x03},
	{0x3022,0x01},
	{0x3031,0x0a},
	{0x3305,0xf1},
	{0x3307,0x04},
	{0x3309,0x29},
	{0x3500,0x00},
	{0x3501,0x48},
	{0x3502,0x00},
	{0x3503,0x04},
	{0x3504,0x00},
	{0x3505,0x00},
	{0x3506,0x00},
	{0x3507,0x00},
	{0x3508,0x00},
	{0x3509,0x80},
	{0x350a,0x00},
	{0x350b,0x00},
	{0x350c,0x00},
	{0x350d,0x00},
	{0x350e,0x00},
	{0x350f,0x80},
	{0x3510,0x00},
	{0x3511,0x00},
	{0x3512,0x00},
	{0x3513,0x00},
	{0x3514,0x00},
	{0x3515,0x80},
	{0x3516,0x00},
	{0x3517,0x00},
	{0x3518,0x00},
	{0x3519,0x00},
	{0x351a,0x00},
	{0x351b,0x80},
	{0x351c,0x00},
	{0x351d,0x00},
	{0x351e,0x00},
	{0x351f,0x00},
	{0x3520,0x00},
	{0x3521,0x80},
	{0x3522,0x08},
	{0x3524,0x08},
	{0x3526,0x08},
	{0x3528,0x08},
	{0x352a,0x08},
	{0x3602,0x00},
	{0x3604,0x02},
	{0x3605,0x00},
	{0x3606,0x00},
	{0x3607,0x00},
	{0x3609,0x12},
	{0x360a,0x40},
	{0x360c,0x08},
	{0x360f,0xe5},
	{0x3608,0x8f},
	{0x3611,0x00},
	{0x3613,0xf7},
	{0x3616,0x58},
	{0x3619,0x99},
	{0x361b,0x60},
	{0x361c,0x7a},
	{0x361e,0x79},
	{0x361f,0x02},
	{0x3632,0x00},
	{0x3633,0x10},
	{0x3634,0x10},
	{0x3635,0x10},
	{0x3636,0x15},
	{0x3646,0x86},
	{0x364a,0x0b},
	{0x3700,0x17},
	{0x3701,0x22},
	{0x3703,0x10},
	{0x370a,0x37},
	{0x3705,0x00},
	{0x3706,0x63},
	{0x3709,0x3c},
	{0x370b,0x01},
	{0x370c,0x30},
	{0x3710,0x24},
	{0x3711,0x0c},
	{0x3716,0x00},
	{0x3720,0x28},
	{0x3729,0x7b},
	{0x372a,0x84},
	{0x372b,0xbd},
	{0x372c,0xbc},
	{0x372e,0x52},
	{0x373c,0x0e},
	{0x373e,0x33},
	{0x3743,0x10},
	{0x3744,0x88},
	{0x374a,0x43},
	{0x374c,0x00},
	{0x374e,0x23},
	{0x3751,0x7b},
	{0x3752,0x84},
	{0x3753,0xbd},
	{0x3754,0xbc},
	{0x3756,0x52},
	{0x375c,0x00},
	{0x3760,0x00},
	{0x3761,0x00},
	{0x3762,0x00},
	{0x3763,0x00},
	{0x3764,0x00},
	{0x3767,0x04},
	{0x3768,0x04},
	{0x3769,0x08},
	{0x376a,0x08},
	{0x376b,0x20},
	{0x376c,0x00},
	{0x376d,0x00},
	{0x376e,0x00},
	{0x3773,0x00},
	{0x3774,0x51},
	{0x3776,0xbd},
	{0x3777,0xbd},
	{0x3781,0x18},
	{0x3783,0x25},
	{0x3800,0x01},
	{0x3801,0x88},
	{0x3802,0x00},
	{0x3803,0xe0},
	{0x3804,0x09},
	{0x3805,0x17},
	{0x3806,0x05},
	{0x3807,0x1f},
	{0x3808,0x07},
	{0x3809,0x80},
	{0x380a,0x04},
	{0x380b,0x38},
	{0x380c,0x06},
	{0x380d,0xB8},
	{0x380e,0x04},
	{0x380f,0x8A},
	{0x3810,0x00},
	{0x3811,0x08},
	{0x3812,0x00},
	{0x3813,0x04},
	{0x3814,0x01},
	{0x3815,0x01},
	{0x3819,0x01},
	{0x3820,0x00},
	{0x3821,0x06},
	{0x3829,0x00},
	{0x382a,0x01},
	{0x382b,0x01},
	{0x382d,0x7f},
	{0x3830,0x04},
	{0x3836,0x01},
	{0x3841,0x02},
	{0x3846,0x08},
	{0x3847,0x07},
	{0x3d85,0x36},
	{0x3d8c,0x71},
	{0x3d8d,0xcb},
	{0x3f0a,0x00},
	{0x4000,0x71},
	{0x4001,0x40},
	{0x4002,0x04},
	{0x4003,0x14},
	{0x400e,0x00},
	{0x4011,0x00},
	{0x401a,0x00},
	{0x401b,0x00},
	{0x401c,0x00},
	{0x401d,0x00},
	{0x401f,0x00},
	{0x4020,0x00},
	{0x4021,0x10},
	{0x4022,0x06},
	{0x4023,0x13},
	{0x4024,0x07},
	{0x4025,0x40},
	{0x4026,0x07},
	{0x4027,0x50},
	{0x4028,0x00},
	{0x4029,0x02},
	{0x402a,0x06},
	{0x402b,0x04},
	{0x402c,0x02},
	{0x402d,0x02},
	{0x402e,0x0e},
	{0x402f,0x04},
	{0x4302,0xff},
	{0x4303,0xff},
	{0x4304,0x00},
	{0x4305,0x00},
	{0x4306,0x00},
	{0x4308,0x02},
	{0x4500,0x6c},
	{0x4501,0xc4},
	{0x4502,0x40},
	{0x4503,0x02},
	{0x4601,0x77},
	{0x4800,0x04},
	{0x4813,0x08},
	{0x481f,0x40},
	{0x4829,0x78},
	{0x4837,0x10},
	{0x4b00,0x2a},
	{0x4b0d,0x00},
	{0x4d00,0x04},
	{0x4d01,0x42},
	{0x4d02,0xd1},
	{0x4d03,0x93},
	{0x4d04,0xf5},
	{0x4d05,0xc1},
	{0x5000,0xf3},
	{0x5001,0x11},
	{0x5004,0x00},
	{0x500a,0x00},
	{0x500b,0x00},
	{0x5032,0x00},
	{0x5040,0x00},
	{0x5050,0x0c},
	{0x5500,0x00},
	{0x5501,0x10},
	{0x5502,0x01},
	{0x5503,0x0f},
	{0x8000,0x00},
	{0x8001,0x00},
	{0x8002,0x00},
	{0x8003,0x00},
	{0x8004,0x00},
	{0x8005,0x00},
	{0x8006,0x00},
	{0x8007,0x00},
	{0x8008,0x00},
	{0x3638,0x00},
	{0x3105,0x31},
	{0x301a,0xf9},
	{0x3508,0x07},
	{0x484b,0x05},
	{0x4805,0x03},
	{0x3601,0x01},
	{0x3745,0xc0},
	{0x3798,0x1b},
	{0x0100,0x01},
	{0xffff,0x64},
	{0x3105,0x11},
	{0x301a,0xf1},
	{0x4805,0x00},
	{0x301a,0xf0},
	{0x3208,0x00},
	{0x302a,0x00},
	{0x302a,0x00},
	{0x302a,0x00},
	{0x302a,0x00},
	{0x302a,0x00},
	{0x3601,0x00},
	{0x3638,0x00},
	{0x3208,0x10},
	{0x3208,0xa0}
};

static const regval_t s_ov489_1080p_30fps_4d[] =
{
	{0x0103,0x01},
	{0x3638,0x00},
	{0x0300,0x02},
	{0x0302,0x32},
	{0x0303,0x00},
	{0x0304,0x03},
	{0x030b,0x00},
	{0x030d,0x1e},
	{0x030e,0x04},
	{0x030f,0x01},
	{0x0312,0x01},
	{0x031e,0x00},
	{0x3000,0x20},
	{0x3002,0x00},
	{0x3018,0x72},
	{0x3020,0x93},
	{0x3021,0x03},
	{0x3022,0x01},
	{0x3031,0x0a},
	{0x3305,0xf1},
	{0x3307,0x04},
	{0x3309,0x29},
	{0x3500,0x00},
	{0x3501,0x4c},
	{0x3502,0x00},
	{0x3503,0x04},
	{0x3504,0x00},
	{0x3505,0x00},
	{0x3506,0x00},
	{0x3507,0x00},
	{0x3508,0x00},
	{0x3509,0x80},
	{0x350a,0x00},
	{0x350b,0x00},
	{0x350c,0x00},
	{0x350d,0x00},
	{0x350e,0x00},
	{0x350f,0x80},
	{0x3510,0x00},
	{0x3511,0x00},
	{0x3512,0x00},
	{0x3513,0x00},
	{0x3514,0x00},
	{0x3515,0x80},
	{0x3516,0x00},
	{0x3517,0x00},
	{0x3518,0x00},
	{0x3519,0x00},
	{0x351a,0x00},
	{0x351b,0x80},
	{0x351c,0x00},
	{0x351d,0x00},
	{0x351e,0x00},
	{0x351f,0x00},
	{0x3520,0x00},
	{0x3521,0x80},
	{0x3522,0x08},
	{0x3524,0x08},
	{0x3526,0x08},
	{0x3528,0x08},
	{0x352a,0x08},
	{0x3602,0x00},
	{0x3603,0x40},
	{0x3604,0x02},
	{0x3605,0x00},
	{0x3606,0x00},
	{0x3607,0x00},
	{0x3609,0x12},
	{0x360a,0x40},
	{0x360c,0x08},
	{0x360f,0xe5},
	{0x3608,0x8f},
	{0x3611,0x00},
	{0x3613,0xf7},
	{0x3616,0x58},
	{0x3619,0x99},
	{0x361b,0x60},
	{0x361c,0x7a},
	{0x361e,0x79},
	{0x361f,0x02},
	{0x3632,0x00},
	{0x3633,0x10},
	{0x3634,0x10},
	{0x3635,0x10},
	{0x3636,0x15},
	{0x3646,0x86},
	{0x364a,0x0b},
	{0x3700,0x17},
	{0x3701,0x22},
	{0x3703,0x10},
	{0x370a,0x37},
	{0x3705,0x00},
	{0x3706,0x63},
	{0x3709,0x3c},
	{0x370b,0x01},
	{0x370c,0x30},
	{0x3710,0x24},
	{0x3711,0x0c},
	{0x3716,0x00},
	{0x3720,0x28},
	{0x3729,0x7b},
	{0x372a,0x84},
	{0x372b,0xbd},
	{0x372c,0xbc},
	{0x372e,0x52},
	{0x373c,0x0e},
	{0x373e,0x33},
	{0x3743,0x10},
	{0x3744,0x88},
	{0x3745,0xc0},
	{0x374a,0x43},
	{0x374c,0x00},
	{0x374e,0x23},
	{0x3751,0x7b},
	{0x3752,0x84},
	{0x3753,0xbd},
	{0x3754,0xbc},
	{0x3756,0x52},
	{0x375c,0x00},
	{0x3760,0x00},
	{0x3761,0x00},
	{0x3762,0x00},
	{0x3763,0x00},
	{0x3764,0x00},
	{0x3767,0x04},
	{0x3768,0x04},
	{0x3769,0x08},
	{0x376a,0x08},
	{0x376b,0x20},
	{0x376c,0x00},
	{0x376d,0x00},
	{0x376e,0x00},
	{0x3773,0x00},
	{0x3774,0x51},
	{0x3776,0xbd},
	{0x3777,0xbd},
	{0x3781,0x18},
	{0x3783,0x25},
	{0x3798,0x1b},
	{0x3800,0x01},
	{0x3801,0x88},
	{0x3802,0x00},
	{0x3803,0xe0},
	{0x3804,0x09},
	{0x3805,0x17},
	{0x3806,0x05},
	{0x3807,0x1f},
	{0x3808,0x07},
	{0x3809,0x80},
	{0x380a,0x04},
	{0x380b,0x38},
	{0x380c,0x0d},
	{0x380d,0x70},
	{0x380e,0x04},
	{0x380f,0x8A},
	{0x3810,0x00},
	{0x3811,0x08},
	{0x3812,0x00},
	{0x3813,0x04},
	{0x3814,0x01},
	{0x3815,0x01},
	{0x3819,0x01},
	{0x3820,0x06},
	{0x3821,0x00},
	{0x3829,0x00},
	{0x382a,0x01},
	{0x382b,0x01},
	{0x382d,0x7f},
	{0x3830,0x04},
	{0x3836,0x01},
	{0x3837,0x00},
	{0x3841,0x02},
	{0x3846,0x08},
	{0x3847,0x07},
	{0x3d85,0x36},
	{0x3d8c,0x71},
	{0x3d8d,0xcb},
	{0x3f0a,0x00},
	{0x4000,0xf1},
	{0x4001,0x40},
	{0x4002,0x04},
	{0x4003,0x14},
	{0x400e,0x00},
	{0x4011,0x00},
	{0x401a,0x00},
	{0x401b,0x00},
	{0x401c,0x00},
	{0x401d,0x00},
	{0x401f,0x00},
	{0x4020,0x00},
	{0x4021,0x10},
	{0x4022,0x06},
	{0x4023,0x13},
	{0x4024,0x07},
	{0x4025,0x40},
	{0x4026,0x07},
	{0x4027,0x50},
	{0x4028,0x00},
	{0x4029,0x02},
	{0x402a,0x06},
	{0x402b,0x04},
	{0x402c,0x02},
	{0x402d,0x02},
	{0x402e,0x0e},
	{0x402f,0x04},
	{0x4302,0xff},
	{0x4303,0xff},
	{0x4304,0x00},
	{0x4305,0x00},
	{0x4306,0x00},
	{0x4308,0x02},
	{0x4500,0x6c},
	{0x4501,0xc4},
	{0x4502,0x40},
	{0x4503,0x01},
	{0x4601,0x77},
	{0x4800,0x04},
	{0x4813,0x08},
	{0x481f,0x40},
	{0x4829,0x78},
	{0x4837,0x10},
	{0x4b00,0x2a},
	{0x4b0d,0x00},
	{0x4d00,0x04},
	{0x4d01,0x42},
	{0x4d02,0xd1},
	{0x4d03,0x93},
	{0x4d04,0xf5},
	{0x4d05,0xc1},
	{0x5000,0xf3},
	{0x5001,0x11},
	{0x5004,0x00},
	{0x500a,0x00},
	{0x500b,0x00},
	{0x5032,0x00},
	{0x5040,0x00},
	{0x5050,0x0c},
	{0x5500,0x00},
	{0x5501,0x10},
	{0x5502,0x01},
	{0x5503,0x0f},
	{0x8000,0x00},
	{0x8001,0x00},
	{0x8002,0x00},
	{0x8003,0x00},
	{0x8004,0x00},
	{0x8005,0x00},
	{0x8006,0x00},
	{0x8007,0x00},
	{0x8008,0x00},
	{0x3638,0x00},
	
};

static const regval_t s_ov489_1080p_30fps_2d[] =
{
	{0x0103,0x01},
	{0x3638,0x00},
	{0x0300,0x00},
	{0x0302,0x20},
	{0x0303,0x00},
	{0x0304,0x03},
	{0x030b,0x00},
	{0x030d,0x1e},
	{0x030e,0x04},
	{0x030f,0x01},
	{0x0312,0x01},
	{0x031e,0x00},
	{0x3000,0x20},
	{0x3002,0x00},
	{0x3018,0x32},
	{0x3019,0x0c},
	{0x3020,0x93},
	{0x3021,0x03},
	{0x3022,0x01},
	{0x3031,0x0a},
	{0x303f,0x0c},
	{0x3305,0xf1},
	{0x3307,0x04},
	{0x3309,0x29},
	{0x3500,0x00},
	{0x3501,0x4c},
	{0x3502,0x00},
	{0x3503,0x04},
	{0x3504,0x00},
	{0x3505,0x00},
	{0x3506,0x00},
	{0x3507,0x00},
	{0x3508,0x00},
	{0x3509,0x80},
	{0x350a,0x00},
	{0x350b,0x00},
	{0x350c,0x00},
	{0x350d,0x00},
	{0x350e,0x00},
	{0x350f,0x80},
	{0x3510,0x00},
	{0x3511,0x00},
	{0x3512,0x00},
	{0x3513,0x00},
	{0x3514,0x00},
	{0x3515,0x80},
	{0x3516,0x00},
	{0x3517,0x00},
	{0x3518,0x00},
	{0x3519,0x00},
	{0x351a,0x00},
	{0x351b,0x80},
	{0x351c,0x00},
	{0x351d,0x00},
	{0x351e,0x00},
	{0x351f,0x00},
	{0x3520,0x00},
	{0x3521,0x80},
	{0x3522,0x08},
	{0x3524,0x08},
	{0x3526,0x08},
	{0x3528,0x08},
	{0x352a,0x08},
	{0x3602,0x00},
	{0x3603,0x40},
	{0x3604,0x02},
	{0x3605,0x00},
	{0x3606,0x00},
	{0x3607,0x00},
	{0x3609,0x12},
	{0x360a,0x40},
	{0x360c,0x08},
	{0x360f,0xe5},
	{0x3608,0x8f},
	{0x3611,0x00},
	{0x3613,0xf7},
	{0x3616,0x58},
	{0x3619,0x99},
	{0x361b,0x60},
	{0x361c,0x7a},
	{0x361e,0x79},
	{0x361f,0x02},
	{0x3632,0x00},
	{0x3633,0x10},
	{0x3634,0x10},
	{0x3635,0x10},
	{0x3636,0x15},
	{0x3646,0x86},
	{0x364a,0x0b},
	{0x3700,0x17},
	{0x3701,0x22},
	{0x3703,0x10},
	{0x370a,0x37},
	{0x3705,0x00},
	{0x3706,0x63},
	{0x3709,0x3c},
	{0x370b,0x01},
	{0x370c,0x30},
	{0x3710,0x24},
	{0x3711,0x0c},
	{0x3716,0x00},
	{0x3720,0x28},
	{0x3729,0x7b},
	{0x372a,0x84},
	{0x372b,0xbd},
	{0x372c,0xbc},
	{0x372e,0x52},
	{0x373c,0x0e},
	{0x373e,0x33},
	{0x3743,0x10},
	{0x3744,0x88},
	{0x3745,0xc0},
	{0x374a,0x43},
	{0x374c,0x00},
	{0x374e,0x23},
	{0x3751,0x7b},
	{0x3752,0x84},
	{0x3753,0xbd},
	{0x3754,0xbc},
	{0x3756,0x52},
	{0x375c,0x00},
	{0x3760,0x00},
	{0x3761,0x00},
	{0x3762,0x00},
	{0x3763,0x00},
	{0x3764,0x00},
	{0x3767,0x04},
	{0x3768,0x04},
	{0x3769,0x08},
	{0x376a,0x08},
	{0x376b,0x20},
	{0x376c,0x00},
	{0x376d,0x00},
	{0x376e,0x00},
	{0x3773,0x00},
	{0x3774,0x51},
	{0x3776,0xbd},
	{0x3777,0xbd},
	{0x3781,0x18},
	{0x3783,0x25},
	{0x3798,0x1b},
	{0x3800,0x01},
	{0x3801,0x88},
	{0x3802,0x00},
	{0x3803,0xe0},
	{0x3804,0x09},
	{0x3805,0x17},
	{0x3806,0x05},
	{0x3807,0x1f},
	{0x3808,0x07},
	{0x3809,0x80},
	{0x380a,0x04},
	{0x380b,0x38},
	{0x380c,0x0d},
	{0x380d,0x70},
	{0x380e,0x04},
	{0x380f,0x8a},
	{0x3810,0x00},
	{0x3811,0x08},
	{0x3812,0x00},
	{0x3813,0x04},
	{0x3814,0x01},
	{0x3815,0x01},
	{0x3819,0x01},
	{0x3820,0x06},
	{0x3821,0x00},
	{0x3829,0x00},
	{0x382a,0x01},
	{0x382b,0x01},
	{0x382d,0x7f},
	{0x3830,0x04},
	{0x3836,0x01},
	{0x3837,0x00},
	{0x3841,0x02},
	{0x3846,0x08},
	{0x3847,0x07},
	{0x3d85,0x36},
	{0x3d8c,0x71},
	{0x3d8d,0xcb},
	{0x3f0a,0x00},
	{0x4000,0xf1},
	{0x4001,0x40},
	{0x4002,0x04},
	{0x4003,0x14},
	{0x400e,0x00},
	{0x4011,0x00},
	{0x401a,0x00},
	{0x401b,0x00},
	{0x401c,0x00},
	{0x401d,0x00},
	{0x401f,0x00},
	{0x4020,0x00},
	{0x4021,0x10},
	{0x4022,0x06},
	{0x4023,0x13},
	{0x4024,0x07},
	{0x4025,0x40},
	{0x4026,0x07},
	{0x4027,0x50},
	{0x4028,0x00},
	{0x4029,0x02},
	{0x402a,0x06},
	{0x402b,0x04},
	{0x402c,0x02},
	{0x402d,0x02},
	{0x402e,0x0e},
	{0x402f,0x04},
	{0x4302,0xff},
	{0x4303,0xff},
	{0x4304,0x00},
	{0x4305,0x00},
	{0x4306,0x00},
	{0x4308,0x02},
	{0x4500,0x6c},
	{0x4501,0xc4},
	{0x4502,0x40},
	{0x4503,0x01},
	{0x4601,0x77},
	{0x4800,0x04},
	{0x4813,0x08},
	{0x481f,0x40},
	{0x4829,0x78},
	{0x4837,0x10},
	{0x4b00,0x2a},
	{0x4b0d,0x00},
	{0x4d00,0x04},
	{0x4d01,0x42},
	{0x4d02,0xd1},
	{0x4d03,0x93},
	{0x4d04,0xf5},
	{0x4d05,0xc1},
	{0x5000,0xf3},
	{0x5001,0x11},
	{0x5004,0x00},
	{0x500a,0x00},
	{0x500b,0x00},
	{0x5032,0x00},
	{0x5040,0x00},
	{0x5050,0x0c},
	{0x5500,0x00},
	{0x5501,0x10},
	{0x5502,0x01},
	{0x5503,0x0f},
	{0x8000,0x00},
	{0x8001,0x00},
	{0x8002,0x00},
	{0x8003,0x00},
	{0x8004,0x00},
	{0x8005,0x00},
	{0x8006,0x00},
	{0x8007,0x00},
	{0x8008,0x00},
	{0x3638,0x00}
};
	

const struct {
		mipicam_mode_t mode;
		const regval_t * regval;
		int regval_num;
} ov4689_mode_params[] = {
		{ MODE_1080P_30FPS_4D, REGVALLIST(s_ov489_1080p_30fps_4d) },
		{ MODE_1080P_60FPS_4D, REGVALLIST(s_ov489_1080p_60fps_4d) },
		{ MODE_1080P_30FPS_2D, REGVALLIST(s_ov489_1080p_30fps_2d) },
	};

typedef enum
{
    CAM_OV4689
} mipicam_t;

struct reg_value {
	u16 u16RegAddr;
	u8 u8Val;
	u8 u8Mask;
	u32 u32Delay_ms;
};

struct ov4689 {
	struct i2c_client *i2c_client;
	struct device *dev;

	u32 reset_pin;
	mipicam_mode_t mode;

	struct mutex lock; /* lock to protect power state, ctrls and mode */
	bool power_on;

	struct gpio_desc *enable_gpio;
};

static int ov4689_write_reg(struct i2c_client *client,u16 reg, u8 val)
{
	u8 au8Buf[3] = {0};

	au8Buf[0] = reg >> 8;
	au8Buf[1] = reg & 0xff;
	au8Buf[2] = val;

	if (i2c_master_send(client, au8Buf, 3) < 0) {
		pr_err("%s:write reg error:reg=%x,val=%x\n",
			__func__, reg, val);
		return -1;
	}

	return 0;
}

static int ov4689_read_reg(struct i2c_client *client,u16 reg, u8 *val)
{
	u8 au8RegBuf[2] = {0};
	u8 u8RdVal = 0;
	int valrtn = 0;

	au8RegBuf[0] = reg >> 8;
	au8RegBuf[1] = reg & 0xff;

    valrtn = i2c_master_send(client, au8RegBuf, 2);
	if (2 != valrtn) {
		pr_err("%s:write reg error:reg=%x,valrtn=%d\n",
				__func__, reg,valrtn);
		return -1;
	}
	
	if (1 != i2c_master_recv(client, &u8RdVal, 1)) {
		pr_err("%s:read reg error:reg=%x,val=%x\n",
				__func__, reg, u8RdVal);
		return -1;
	}

	*val = u8RdVal;

	return u8RdVal;
}

static int ov4689_gpio_reserve(int pin, int dir,const char *name)
{
	int ret = -ENODEV;
	if (!gpio_is_valid(pin))
		return ret;

	ret = gpio_request(pin, name);
	if (ret) {
		return ret;
	}

	ret = gpio_direction_output(pin, dir);
	if (ret) {
		gpio_free(pin);
		return ret;
	}

	return 0;
}

static void ov4689_gpio_release(int pin, const char *name)
{
	if (gpio_is_valid(pin)) {
		gpio_free(pin);
	}
}
static int ov4689_power_down(struct ov4689 *ov4689)
{
    // software standby
    ov4689_write_reg(ov4689->i2c_client,0x100, 0);
    
    ov4689_gpio_reserve(ov4689->reset_pin, 0,
				   "gpio-restart");
    // according to "VIC_SON_MIPI_CSI_2K4K_V10" schmatics, PWDN is high and not configurable
    //gpio_set_low(dev->pwdn_pin);
    
    return 0;
}

static int ov4689_power_up(struct ov4689 *ov4689)
{
	int ret;
	u8 chip_id_hi = 0xff;
    u8 chip_id_lo = 0xff;

	/* Power configuration */
	ret = ov4689_gpio_reserve(ov4689->reset_pin, 0,"gpio-restart");
	if (ret)
		goto disable;

	if (gpio_is_valid(ov4689->reset_pin)) {
		usleep_range(5000, 25000);
	    //gpio_direction_output(dev->reset_pin, 1);
	    gpio_set_value(ov4689->reset_pin, 1);
	}
	udelay(8192*MCLK_INTERVAL_US); // t2: 8192 EXTCLK delay

    ov4689_read_reg(ov4689->i2c_client,0x300a, &chip_id_hi);
    ov4689_read_reg(ov4689->i2c_client,0x300b, &chip_id_lo);
    if (chip_id_hi != 0x46 && chip_id_lo != 0x88) {
        return -EINVAL;
    } else {
        pr_info("ov4689 @ bus dev 0x%x powered up!\n", ov4689->i2c_client->addr);
    }
    return 0;
disable:
	return ret;

}

static int ov4689_set_power_on(struct ov4689 *ov4689)
{
    return ov4689_power_up(ov4689);
}

static int ov4689_start(struct ov4689 *ov4689)
{
    int result = ov4689_write_reg(ov4689->i2c_client,0x100, 1);
	u8 val;
	ov4689_read_reg(ov4689->i2c_client,0x100, &val);
    mdelay(200);
    return result;
}

static int ov4689_stop(struct ov4689 *ov4689)
{
    int result = ov4689_write_reg(ov4689->i2c_client,0x100, 0);
	u8 val;
	ov4689_read_reg(ov4689->i2c_client,0x100, &val);
    mdelay(200);
    return result;
}

static int ov4689_set_mode(struct ov4689 *ov4689)
{
	int i, j;
	for (i = 0; i < sizeof(ov4689_mode_params)/sizeof(ov4689_mode_params[0]); i++) {
		if (ov4689->mode == ov4689_mode_params[i].mode) {
			for (j = 0; j < ov4689_mode_params[i].regval_num; j++) {
				ov4689_write_reg(ov4689->i2c_client,ov4689_mode_params[i].regval[j].addr, ov4689_mode_params[i].regval[j].val);
			}
			return 0;
		}
	}
	
	return -EINVAL;
}

int mipicam_set_mode(struct ov4689 *ov4689)
{
    if (!ov4689 ) {
        return -EINVAL;
    }
    
	ov4689_stop(ov4689);

    return ov4689_set_mode(ov4689);
}

static void ov4689_set_power_down(struct ov4689 *ov4689)
{
    ov4689_stop(ov4689);
    ov4689_power_down(ov4689);
}

/*!
 * ov4689 I2C probe function
 *
 * @param adapter            struct i2c_adapter *
 * @return  Error code indicating success or failure
 */
static int ov4689_probe(struct i2c_client *client,
			const struct i2c_device_id *id)
{
	struct device *dev = &client->dev;
	struct ov4689 *ov4689;
	int ret;

	ov4689 = devm_kzalloc(dev, sizeof(struct ov4689), GFP_KERNEL);
	if (!ov4689)
		return -ENOMEM;
		
    ov4689->i2c_client = client;
	ov4689->dev = dev;
	ov4689->mode = MODE_1080P_30FPS_2D;
	
	struct device_node *np = client->dev.of_node;
    ov4689->reset_pin = of_get_named_gpio(np, "reset-gpio", 0);
    ret = ov4689_set_power_on(ov4689);
	if (ret) {
	   MIPI_ERR("failed to open sensor\n");
	   goto RELEASE_GPIOS;
	}

	if (mipicam_set_mode(ov4689)) {
		   MIPI_ERR("mode %d not supported by sensor[i2c_bus 0]\n", ov4689->mode);
		   goto EXIT;
	}
	
    ov4689_start(ov4689);
    return 0;

   EXIT:
	   /* stop and close sensor */
	   ov4689_set_power_down(ov4689);
	   return 0;
   RELEASE_GPIOS:
	   ov4689_gpio_release(ov4689->reset_pin, "gpio-restart");
       return 0;
}

/*!
 * ov4689 I2C detach function
 *
 * @param client            struct i2c_client *
 * @return  Error code indicating success or failure
 */
static int ov4689_remove(struct i2c_client *client)
{
	return 0;
}

static const struct i2c_device_id ov4689_id[] = {
	{"ov4689", 0},
	{},
};

MODULE_DEVICE_TABLE(i2c, ov4689_id);

static struct i2c_driver ov4689_i2c_driver = {
	.driver = {
		  .owner = THIS_MODULE,
		  .name  = "ov4689_mipi",
		  },
	.probe  = ov4689_probe,
	.remove = ov4689_remove,
	.id_table = ov4689_id,
};

static __init int init_ov4689(void)
{ 
    int err;

	err = i2c_add_driver(&ov4689_i2c_driver);
    if (err != 0)
		printk("i2c driver registration failed, error=%d\n", err);

	return err;
}

static __exit void exit_ov4689(void)
{
	i2c_del_driver(&ov4689_i2c_driver);
}

fs_initcall(init_ov4689);
module_exit(exit_ov4689);

MODULE_AUTHOR("StarFive Technology Co., Ltd.");
MODULE_DESCRIPTION("OV4689 Mipi Camera Driver");
MODULE_LICENSE("GPL");
MODULE_VERSION("1.0");
MODULE_ALIAS("DVP");
